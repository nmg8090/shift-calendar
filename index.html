<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="description" content="10Ïùº Ï£ºÍ∏∞ ÍµêÎåÄÍ∑ºÎ¨¥ÌëúÎ•º ÌïúÎààÏóê Î≥¥Ïó¨Ï£ºÎäî PWA Ï∫òÎ¶∞Îçî">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="apple-touch-icon" href="icons/calendar-symbol.svg">
<title>ÍµêÎåÄÍ∑ºÎ¨¥Ìëú</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Pretendard:wght@400;500;600;700&display=swap');

:root {
  --day: #0ea5e9; --night: #6366f1; --mid: #8b5cf6;
  --off: #22c55e; --rest: #f87171; --holiday: #f87171;
  --bg: #ffffff; --bg2: #ffffff; --card: #ffffff; --card-solid: #ffffff;
  --glass: rgba(255,255,255,0.95); --glass-border: rgba(148,163,184,0.2);
  --text: #0f172a; --text2: #475569; --muted: #64748b;
  --radius: 16px; --radius-sm: 10px;
  --shadow: 0 10px 30px rgba(15,23,42,0.12);
  --bg-dark: linear-gradient(180deg, #030611, #0c1222 60%, #090b17);
  --bg-light: linear-gradient(180deg, #fafbff, #f1f5f9);
  --card-dark: rgba(17,24,39,0.85);
  --card-light: rgba(255,255,255,0.92);
  --glass-dark: rgba(255,255,255,0.12);
  --glass-light: rgba(255,255,255,0.95);
  --shadow-light: 0 10px 40px rgba(15,23,42,0.08);
  --heading-font: 'Cormorant Garamond', 'Playfair Display', serif;
  --body-font: 'Pretendard', 'Noto Sans KR', 'Source Sans 3', system-ui, sans-serif;
  --cell-height: 150px;
  --cal-border: 1px solid rgba(226,232,240,0.8);
  --cal-inner-padding: 6px;
  --container-max: 100%;
  --cell-gap: 4px;
}


.light {
  --bg: #f1f5f9; --bg2: #e2e8f0; --card: rgba(255,255,255,0.6); --card-solid: #fff;
  --glass: rgba(255,255,255,0.4); --glass-border: rgba(0,0,0,0.06);
  --text: #1e293b; --text2: #334155; --muted: #94a3b8;
  --shadow: 0 8px 32px rgba(0,0,0,0.08);
}
* { margin:0; padding:0; box-sizing:border-box; }
body.week-mode {
  background: #ffffff;
  color: #0f172a;
}
body.week-mode .glass {
  background: rgba(255,255,255,0.9);
  border-color: rgba(226,232,240,0.9);
  box-shadow: 0 12px 40px rgba(15,23,42,0.1);
}
body.week-mode .cal-wrapper {
  background: #ffffff;
  border-color: rgba(226,232,240,0.9);
  box-shadow: 0 12px 40px rgba(15,23,42,0.1);
}
body.week-mode .calendar {
  background: #ffffff;
  border-color: rgba(226,232,240,0.9);
}
body.week-mode .cell {
  background: #ffffff;
  border-color: rgba(209,213,219,0.8);
}

body.light {
  background: #ffffff;
  color: #0f172a;
}
body.light .container {
  color: #0f172a;
}
body.light .cal-wrapper {
  background: rgba(255,255,255,0.95);
  border-color: rgba(148,163,184,0.5);
  box-shadow: 0 12px 40px rgba(15,23,42,0.08);
}
body.light .calendar {
  background: #fefefe;
  border-color: rgba(203,213,225,0.6);
}
body.light .cell {
  background: rgba(255,255,255,0.88);
  border-color: rgba(148,163,184,0.55);
}
body.light .glass {
  background: rgba(255,255,255,0.9);
}
body.light .nav-btn {
  background: rgba(14,165,233,0.08);
  border-color: rgba(14,165,233,0.4);
}
body.light .header h1,
body.light .month-label {
  color: #0f172a;
}
body.light .weekdays span { color: #0f172a; }
body.light .today-btn { color:#0f172a; background:#fcd34d; }

body {
  font-family: var(--body-font);
  font-family: var(--body-font);
  font-size: 1.12rem;
  letter-spacing: 0.03em;
  line-height: 1.65;
  font-weight: 400;
  font-feature-settings: 'liga' 1, 'calt' 1;
  background: var(--bg-dark);
  color: #f8fafc;
  min-height: 100dvh; transition: background 0.4s, color 0.4s;
  overflow-x: hidden;
  padding: 0 6px;
}
body.light {
  background: #ffffff;
  color: #0f172a;
}
.container { width: min(100%, 100%); margin: 0 auto; padding: 16px 8px 80px; }

/* Glass card mixin */
.glass {
  background: var(--card); border: 1px solid var(--glass-border);
  border-radius: var(--radius); backdrop-filter: blur(24px);
  box-shadow: var(--shadow);
}
body.light .glass {
  background: var(--card-light);
  border-color: rgba(148,163,184,0.4);
  box-shadow: var(--shadow-light);
}

/* Header */
.header { display:flex; align-items:center; justify-content:space-between; padding:12px 0 8px; }
.header h1 { font-size:1.6rem; font-weight:600; letter-spacing:0.4px; font-family: var(--heading-font); text-transform:uppercase; }
.header-btns { display:flex; gap:6px; }
.icon-btn {
  background: var(--glass); border:1px solid var(--glass-border);
  color: var(--text); border-radius: 12px; width:40px; height:40px;
  display:flex; align-items:center; justify-content:center;
  font-size:1.1rem; cursor:pointer; transition: all 0.2s;
}
.icon-btn:active { transform: scale(0.93); }

.theme-btn.active {
  border-color: var(--day);
  box-shadow: 0 0 0 2px rgba(14,165,233,0.35);
}

/* Shift summary */
.shift-summary {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
  margin:14px 0;
}
.shift-card {
  padding:22px 18px;
  border-radius:20px;
  text-align:center;
  min-height:150px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.shift-card-label {
  font-size:0.75rem;
  letter-spacing:0.3em;
  text-transform:uppercase;
  color:var(--muted);
  font-weight:600;
}
.shift-card-emoji {
  font-size:2rem;
}
.shift-card-shift {
  font-size:2.4rem;
  font-weight:600;
  font-family:var(--heading-font);
  letter-spacing:0.08em;
}
.shift-card-date {
  font-size:0.9rem;
  color:var(--text2);
  letter-spacing:0.08em;
}

/* Start date *//* Start date */
.start-row {
  display:flex; align-items:center; justify-content:center; gap:10px;
  padding:10px; margin:8px 0; font-size:0.85rem;
}
.start-row label { color:var(--muted); font-weight:600; letter-spacing:0.3em; text-transform:uppercase; font-size:0.75rem; }
.start-row input {
  background:var(--glass); border:1px solid var(--glass-border);
  color:var(--text); border-radius:10px; padding:8px 12px; font-size:0.85rem;
  outline:none; transition: border 0.2s;
}
.start-row input:focus { border-color: var(--day); }

/* Controls */
.controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin:10px 0; width:100%; }
.nav-btn {
  background:var(--glass); border:1px solid var(--glass-border); color:var(--text);
  border-radius:12px; padding:10px 18px; font-size:1rem; cursor:pointer;
  transition: all 0.2s; font-weight:500;
}
.nav-btn:active { transform:scale(0.95); background:var(--glass-border); }
.month-label { font-size:1.4rem; font-weight:600; flex:1; min-width:0; text-align:center; font-family: var(--heading-font); letter-spacing:0.3em; text-transform:uppercase; }
.today-btn {
  position:absolute; right:0; background:var(--day); color:#fff; border:none;
  border-radius:8px; padding:6px 12px; font-size:0.75rem; cursor:pointer; font-weight:600;
  letter-spacing:0.2em; text-transform:uppercase; font-family: var(--heading-font);
}
.controls-wrap { position:relative; display:flex; align-items:center; justify-content:center; width:100%; }

/* View toggle */
.view-toggle {
  display:flex; justify-content:center; gap:4px; margin:8px 0;
  background:var(--glass); border:1px solid var(--glass-border);
  border-radius:12px; padding:4px; width:fit-content; margin-left:auto; margin-right:auto;
}
.view-toggle button {
  background:transparent; border:none; color:var(--muted); padding:6px 16px;
  border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:600; transition:all 0.2s;
  letter-spacing:0.18em; text-transform:uppercase; font-family: var(--heading-font);
}
.view-toggle button.active { background:var(--day); color:#fff; }

/* Weekdays */
.weekdays {
  display:grid; grid-template-columns:repeat(7,1fr); text-align:center;
  font-size:1rem; letter-spacing:0.35em; color:var(--muted); padding:12px 0 8px; font-weight:700;
  font-family: var(--heading-font); text-transform:uppercase;
}
.weekdays span:first-child { color:#f87171; }
.weekdays span:last-child { color:#60a5fa; }

/* Calendar grid */
.cal-wrapper { position:relative; overflow:hidden; min-height:360px; padding-top:12px; border-radius:24px; border: 1px solid rgba(255,255,255,0.08); background: rgba(15,23,42,0.85); box-shadow: 0 12px 40px rgba(0,0,0,0.35); }
.calendar {
  display:grid; grid-template-columns:repeat(7,1fr); gap:var(--cell-gap);
  grid-auto-rows: minmax(120px, 1fr);
  transition: opacity 0.15s; padding:var(--cal-inner-padding); width:100%;
  border-radius:20px;
  border: var(--cal-border);
  background: rgba(7,11,21,0.55);
}
.calendar.slide-left { animation: slideLeft 0.3s ease; }
.calendar.slide-right { animation: slideRight 0.3s ease; }

@keyframes slideLeft {
  0% { transform:translateX(60px); opacity:0; }
  100% { transform:translateX(0); opacity:1; }
}
@keyframes slideRight {
  0% { transform:translateX(-60px); opacity:0; }
  100% { transform:translateX(0); opacity:1; }
}
@keyframes fadeSlideUp {
  0% { transform:translateY(20px); opacity:0; }
  100% { transform:translateY(0); opacity:1; }
}
@keyframes fadeIn {
  0% { opacity:0; }
  100% { opacity:1; }
}

 .cell {
  aspect-ratio:1; border-radius:var(--radius-sm);
  min-height:var(--cell-height);
  padding:18px 10px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px;
  background:var(--glass); border:1px solid rgba(255,255,255,0.15);
  position:relative; cursor:pointer; transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.cell-note {
  font-size:0.68rem;
  color:var(--text2);
  margin-top:4px;
  text-align:center;
  max-width:100%;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  font-family: var(--body-font);
  letter-spacing:0.12em;
}
.cell.holiday {
  background:rgba(251,113,133,0.2);
  border-color:rgba(251,113,133,0.35);
}
@media (max-width:520px) {
  .cell.holiday {background:rgba(251,113,133,0.25);}
}
.cell:active { transform:scale(0.93); }
.cell.empty { background:transparent; pointer-events:none; }
.cell .date { font-size:2.2rem; color:var(--muted); margin-bottom:4px; font-weight:700; line-height:1.1; font-family: var(--heading-font); letter-spacing:0.05em; }
.cell .shift { font-weight:700; font-size:2rem; font-family: var(--heading-font); letter-spacing:0.12em; text-transform:uppercase; }
.cell.sun .date { color:#f87171; }
.cell.sat .date { color:#60a5fa; }
.cell.holiday .date { color:#fb7185 !important; }
.cell.holiday::after {
  content:''; position:absolute; top:3px; right:3px;
  width:5px; height:5px; border-radius:50%; background:#fb7185;
}
.cell.today {
  border:2px solid #facc15; background:rgba(250,204,21,0.08);
}
.cell.has-note::before {
  content:''; position:absolute; bottom:3px; left:50%; transform:translateX(-50%);
  width:4px; height:4px; border-radius:50%; background:var(--day);
}
.cell[data-shift="Ï£ºÍ∞Ñ"] .shift { color:var(--day); }
.cell[data-shift="ÏïºÍ∞Ñ"] .shift { color:var(--night); }
.cell[data-shift="Ïã¨Ïïº"] .shift { color:var(--mid); }
.cell[data-shift="ÎπÑÎ≤à"] .shift { color:var(--off); }
.cell[data-shift="Ìú¥Î¨¥"] .shift { color:var(--rest); }

/* Modal */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100;
  display:flex; align-items:flex-end; justify-content:center;
  opacity:0; pointer-events:none; transition:opacity 0.25s;
  backdrop-filter:blur(4px);
}
.modal-overlay.show { opacity:1; pointer-events:auto; }
.modal {
  background:var(--card-solid); border-radius:20px 20px 0 0; padding:24px;
  width:100%; max-width:520px; transform:translateY(100%);
  transition:transform 0.3s ease; max-height:70vh; overflow-y:auto;
}
.modal-overlay.show .modal { transform:translateY(0); }
.modal h3 { font-size:1.4rem; font-weight:600; font-family: var(--heading-font); letter-spacing:0.2em; text-transform:uppercase; margin-bottom:6px; color:var(--text); }
.modal .modal-date { color:var(--muted); font-size:0.85rem; margin-bottom:16px; letter-spacing:0.08em; text-transform:uppercase; }
.modal .modal-shift { font-size:1.8rem; font-weight:800; margin:8px 0; font-family: var(--heading-font); letter-spacing:0.08em; text-transform:uppercase; }
.modal .modal-cycle { font-size:0.85rem; color:var(--text2); margin-bottom:16px; letter-spacing:0.08em; }
.modal .note-area {
  width:100%; background:var(--glass); border:1px solid var(--glass-border);
  color:var(--text); border-radius:12px; padding:12px; font-size:0.9rem;
  resize:none; height:80px; outline:none; font-family:var(--body-font);
  letter-spacing:0.02em; line-height:1.5;
}
.modal .note-area:focus { border-color:var(--day); }
.modal .modal-btns { display:flex; gap:8px; margin-top:12px; }
.modal .modal-btns button {
  flex:1; padding:12px; border:none; border-radius:12px; font-size:0.9rem;
  font-weight:600; cursor:pointer; transition:all 0.15s; font-family: var(--heading-font);
  letter-spacing:0.08em; text-transform:uppercase;
}
.modal .btn-save { background:var(--day); color:#fff; }
.modal .btn-close { background:var(--glass); color:var(--text); border:1px solid var(--glass-border) !important; }
.modal .btn-save:active, .modal .btn-close:active { transform:scale(0.97); }

/* Export toast */
.toast {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%) translateY(60px);
  background:var(--card-solid); color:var(--text); padding:12px 24px;
  border-radius:12px; font-size:0.85rem; font-weight:500; z-index:200; font-family: var(--body-font);
  letter-spacing:0.06em; text-transform:uppercase;
  box-shadow:var(--shadow); transition: transform 0.3s ease, opacity 0.3s;
  opacity:0; pointer-events:none;
}
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

/* Responsive desktop */
@media (max-width:640px) {
  .container { max-width: 100%; padding: 14px 8px 72px; }
  .header { gap: 10px; }
  .header h1 { font-size: 1.6rem; }
  .controls { gap: 6px; }
  .view-toggle { width: 100%; justify-content: center; }
  .weekdays { padding: 8px 0 6px; }
}

body.week-mode .cal-wrapper {
  background: #ffffff;
  border-color: rgba(226,232,240,0.9);
  box-shadow: 0 20px 60px rgba(15,23,42,0.1);
}
body.week-mode .cell {
  background: #ffffff;
  color: #0f172a;
  border-color: rgba(148,163,184,0.4);
}
body.week-mode .cell .date { color: #1f2937; }
body.week-mode .cell .shift { color: #111827; }
body.week-mode .weekdays span { color: #0b0d1a; }

@media (min-width:600px) {
  .container { padding:24px; }
  .cell { min-height:130px; padding:14px 8px; border-radius:14px; }
  .cell .shift { font-size:1.2rem; }
  .cell .date { font-size:1.3rem; }
}

@media (max-width:520px) {
  .cal-wrapper { min-height:460px; padding-top:16px; }
  .calendar { gap:6px; padding:4px; }
  .cell { min-height:150px; padding:14px 8px; }
  .cell .date { font-size:1.7rem; }
  .cell .shift { font-size:1.6rem; }
  .weekdays { font-size:0.9rem; }
}

/* Page load animation */
.container { animation: fadeSlideUp 0.5s ease; }
</style>
</head>
<body>
<div class="container" id="app">
  <!-- Header -->
  <div class="header">
    <h1>üóìÔ∏è ÍµêÎåÄÍ∑ºÎ¨¥Ìëú</h1>
    <div class="header-btns">
      <button class="icon-btn theme-btn" id="dayThemeBtn" title="ÎÇÆ Î™®Îìú">‚òÄÔ∏è</button>
      <button class="icon-btn theme-btn" id="nightThemeBtn" title="Î∞§ Î™®Îìú">üåô</button>
      <button class="icon-btn" id="exportBtn" title="ÎÇ¥Î≥¥ÎÇ¥Í∏∞">üì§</button>
    </div>
  </div>

  <div class="shift-summary">
    <div class="shift-card glass" id="todayShiftCard"></div>
    <div class="shift-card glass" id="tomorrowShiftCard"></div>
  </div>

  <!-- Start date -->
  <div class="start-row glass">
    <label>üìå Í∑ºÎ¨¥ ÏãúÏûëÏùº</label>
    <input type="date" id="startDate">
  </div>

  <!-- Month controls -->
  <div class="controls-wrap">
    <div class="controls">
      <button class="nav-btn" id="prev">‚óÄ</button>
      <div class="month-label" id="monthLabel"></div>
      <button class="nav-btn" id="next">‚ñ∂</button>
    </div>
    <button class="today-btn" id="todayNavBtn">Ïò§Îäò</button>
  </div>

  <!-- Calendar -->
  <div class="weekdays"><span>Ïùº</span><span>Ïõî</span><span>Ìôî</span><span>Ïàò</span><span>Î™©</span><span>Í∏à</span><span>ÌÜ†</span></div>
  <div class="cal-wrapper">
    <div class="calendar" id="cal"></div>
  </div>

</div>

<!-- Detail modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const PATTERN = ['Ï£ºÍ∞Ñ','ÏïºÍ∞Ñ','Ïã¨Ïïº','ÎπÑÎ≤à','Ìú¥Î¨¥','Ï£ºÍ∞Ñ','ÏïºÍ∞Ñ','ÎπÑÎ≤à','ÎπÑÎ≤à','Ìú¥Î¨¥'];
const SHIFT_EMOJI = {'Ï£ºÍ∞Ñ':'‚òÄÔ∏è','ÏïºÍ∞Ñ':'üåô','Ïã¨Ïïº':'üåÉ','ÎπÑÎ≤à':'üèñÔ∏è','Ìú¥Î¨¥':'üò¥'};
const SHIFT_COLOR = {'Ï£ºÍ∞Ñ':'var(--day)','ÏïºÍ∞Ñ':'var(--night)','Ïã¨Ïïº':'var(--mid)','ÎπÑÎ≤à':'var(--off)','Ìú¥Î¨¥':'var(--rest)'};
const DAYS_KR = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];

// Korean holidays 2025-2026
const HOLIDAYS = {
  '2025-01-01':'Ïã†Ï†ï','2025-01-28':'ÏÑ§ÎÇ† Ïó∞Ìú¥','2025-01-29':'ÏÑ§ÎÇ†','2025-01-30':'ÏÑ§ÎÇ† Ïó∞Ìú¥',
  '2025-03-01':'ÏÇºÏùºÏ†à','2025-05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†','2025-05-06':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº',
  '2025-05-15':'Î∂ÄÏ≤òÎãòÏò§Ïã†ÎÇ† (Ïú§4.15 Í∏∞Ï§Ä Ï°∞Ï†ïÍ∞ÄÎä•)',
  '2025-06-06':'ÌòÑÏ∂©Ïùº','2025-08-15':'Í¥ëÎ≥µÏ†à',
  '2025-10-03':'Í∞úÏ≤úÏ†à','2025-10-05':'Ï∂îÏÑù Ïó∞Ìú¥','2025-10-06':'Ï∂îÏÑù','2025-10-07':'Ï∂îÏÑù Ïó∞Ìú¥','2025-10-08':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº',
  '2025-10-09':'ÌïúÍ∏ÄÎÇ†','2025-12-25':'ÌÅ¨Î¶¨Ïä§ÎßàÏä§',
  '2026-01-01':'Ïã†Ï†ï','2026-02-16':'ÏÑ§ÎÇ† Ïó∞Ìú¥','2026-02-17':'ÏÑ§ÎÇ†','2026-02-18':'ÏÑ§ÎÇ† Ïó∞Ìú¥',
  '2026-03-01':'ÏÇºÏùºÏ†à','2026-03-02':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº',
  '2026-05-05':'Ïñ¥Î¶∞Ïù¥ÎÇ†','2026-05-24':'Î∂ÄÏ≤òÎãòÏò§Ïã†ÎÇ†',
  '2026-06-06':'ÌòÑÏ∂©Ïùº','2026-08-15':'Í¥ëÎ≥µÏ†à','2026-08-17':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº',
  '2026-09-24':'Ï∂îÏÑù Ïó∞Ìú¥','2026-09-25':'Ï∂îÏÑù','2026-09-26':'Ï∂îÏÑù Ïó∞Ìú¥',
  '2026-10-03':'Í∞úÏ≤úÏ†à','2026-10-05':'ÎåÄÏ≤¥Í≥µÌú¥Ïùº','2026-10-09':'ÌïúÍ∏ÄÎÇ†',
  '2026-12-25':'ÌÅ¨Î¶¨Ïä§ÎßàÏä§'
};

let viewYear, viewMonth;
let slideDir = '';

const $ = id => document.getElementById(id);
const $cal = $('cal'), $label = $('monthLabel'), $start = $('startDate');
const $todayCard = $('todayShiftCard'), $tomorrowCard = $('tomorrowShiftCard');
const $modal = $('modal'), $overlay = $('modalOverlay'), $toast = $('toast');
const $calWrapper = $cal.parentElement;

function fmt(d) { return d.toISOString().slice(0,10); }
function pad(n) { return n < 10 ? '0'+n : ''+n; }
function fmtLocal(y,m,d) { return y+'-'+pad(m+1)+'-'+pad(d); }
function today() { const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
function todayStr() { return fmt(today()); }

const DEVICE_SIGNATURE = `${navigator.userAgent}|${navigator.language}|${navigator.platform}`;
const STORAGE_KEY = 'shiftCalDevice:' + (window.btoa ? window.btoa(DEVICE_SIGNATURE).replace(/=+$/,'') : encodeURIComponent(DEVICE_SIGNATURE));
const createDefaultDeviceData = () => ({ startDate: fmt(today()), notes: {}, theme: 'dark' });
function loadDeviceData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return createDefaultDeviceData();
  try {
    const parsed = JSON.parse(raw);
    return { ...createDefaultDeviceData(), ...parsed, notes: parsed.notes || {} };
  } catch (err) {
    return createDefaultDeviceData();
  }
}
function persistDeviceData(partial) {
  deviceData = { ...deviceData, ...partial };
  if (!deviceData.notes) deviceData.notes = {};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(deviceData));
}
function getDeviceNotes() {
  return deviceData.notes || {};
}
function saveDeviceNotes(notes) {
  persistDeviceData({ notes });
}

let deviceData = loadDeviceData();

function getShift(dateStr) {
  const start = new Date($start.value+'T00:00:00');
  const cur = new Date(dateStr+'T00:00:00');
  const diff = Math.round((cur - start) / 86400000);
  return PATTERN[((diff % 10) + 10) % 10];
}

function getNotes() { return getDeviceNotes(); }
function saveNotes(n) { saveDeviceNotes(n); }

function formatDisplayDate(date) {
  return `${date.getMonth()+1}/${date.getDate()} (${DAYS_KR[date.getDay()]})`;
}

function sanitizeHTML(str) {
  return str ? str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : '';
}

function renderShiftCards() {
  const todayDate = today();
  const tomorrowDate = new Date(todayDate);
  tomorrowDate.setDate(tomorrowDate.getDate() + 1);
  const todayKey = fmt(todayDate);
  const tomorrowKey = fmt(tomorrowDate);
  const todayShift = getShift(todayKey);
  const tomorrowShift = getShift(tomorrowKey);
  const todayColor = SHIFT_COLOR[todayShift];
  const tomorrowColor = SHIFT_COLOR[tomorrowShift];

  $todayCard.innerHTML = `
    <div class="shift-card-label">Ïò§Îäò</div>
    <div class="shift-card-emoji">${SHIFT_EMOJI[todayShift]}</div>
    <div class="shift-card-shift" style="color:${todayColor}">${todayShift}</div>
    <div class="shift-card-date">${formatDisplayDate(todayDate)}</div>
  `;
  $tomorrowCard.innerHTML = `
    <div class="shift-card-label">ÎÇ¥Ïùº</div>
    <div class="shift-card-emoji">${SHIFT_EMOJI[tomorrowShift]}</div>
    <div class="shift-card-shift" style="color:${tomorrowColor}">${tomorrowShift}</div>
    <div class="shift-card-date">${formatDisplayDate(tomorrowDate)}</div>
  `;
}

function renderMonth() {
  const first = new Date(viewYear, viewMonth, 1);
  const last = new Date(viewYear, viewMonth+1, 0);
  const startDay = first.getDay();
  const days = last.getDate();
  const ts = todayStr();
  const notes = getNotes();

  $label.textContent = `${viewYear}ÎÖÑ ${viewMonth+1}Ïõî`;

  let html = '';
  for (let i = 0; i < startDay; i++) html += '<div class="cell empty"></div>';

  for (let d = 1; d <= days; d++) {
    const ds = fmtLocal(viewYear, viewMonth, d);
    const date = new Date(viewYear, viewMonth, d);
    const dow = date.getDay();
    const shift = getShift(ds);
    const note = notes[ds] ? sanitizeHTML(notes[ds]) : '';
    const cls = ['cell'];
    if (dow === 0) cls.push('sun');
    if (dow === 6) cls.push('sat');
    if (ds === ts) cls.push('today');
    if (HOLIDAYS[ds]) cls.push('holiday');
    if (notes[ds]) cls.push('has-note');
    html += `<div class="${cls.join(' ')}" data-shift="${shift}" data-date="${ds}" onclick="openDetail('${ds}')">
      <span class="date">${d}</span><span class="shift">${shift}</span>${note ? `<div class="cell-note">${note}</div>` : ''}</div>`;
  }
  $cal.innerHTML = html;
  if (slideDir) { $cal.classList.add('slide-'+slideDir); setTimeout(()=>$cal.classList.remove('slide-'+slideDir),300); slideDir=''; }

}

function render() {
  renderShiftCards();
  renderMonth();
}

// Detail modal
function openDetail(ds) {
  const d = new Date(ds+'T00:00:00');
  const shift = getShift(ds);
    const dow = DAYS_KR[d.getDay()];
  const hol = HOLIDAYS[ds];
  const notes = getNotes();
  const note = notes[ds] || '';

  $modal.innerHTML = `
    <h3>${SHIFT_EMOJI[shift]} ${shift}</h3>
    <div class="modal-date">${d.getFullYear()}ÎÖÑ ${d.getMonth()+1}Ïõî ${d.getDate()}Ïùº (${dow})${hol?' ¬∑ üéå '+hol:''}</div>
    <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:6px;">üìù Î©îÎ™®</label>
    <textarea class="note-area" id="noteInput" placeholder="Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">${note}</textarea>
    <div class="modal-btns">
      <button class="btn-close" onclick="closeModal()">Îã´Í∏∞</button>
      <button class="btn-save" onclick="saveNote('${ds}')">Ï†ÄÏû•</button>
    </div>
  `;
  $overlay.classList.add('show');
}

function closeModal() { $overlay.classList.remove('show'); }
$overlay.addEventListener('click', e => { if (e.target === $overlay) closeModal(); });

function saveNote(ds) {
  const notes = getNotes();
  const val = document.getElementById('noteInput').value.trim();
  if (val) notes[ds] = val; else delete notes[ds];
  saveNotes(notes);
  closeModal();
  render();
  showToast('Î©îÎ™®Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§ ‚úÖ');
}

// Toast
function showToast(msg) {
  $toast.textContent = msg;
  $toast.classList.add('show');
  setTimeout(()=>$toast.classList.remove('show'), 2000);
}

// Theme
function setThemeMode(mode) {
  const light = mode === 'light';
  document.body.classList.toggle('light', light);
  document.querySelector('meta[name="theme-color"]').content = light ? '#f1f5f9' : '#0f172a';
  persistDeviceData({ theme: light ? 'light' : 'dark' });
  $('dayThemeBtn').classList.toggle('active', light);
  $('nightThemeBtn').classList.toggle('active', !light);
}
$('dayThemeBtn').addEventListener('click', () => setThemeMode('light'));
$('nightThemeBtn').addEventListener('click', () => setThemeMode('dark'));

// Navigation
function navPrev() {
  slideDir = 'right';
  viewMonth--; if (viewMonth < 0) { viewMonth = 11; viewYear--; }
  render();
}
function navNext() {
  slideDir = 'left';
  viewMonth++; if (viewMonth > 11) { viewMonth = 0; viewYear++; }
  render();
}
$('prev').addEventListener('click', navPrev);
$('next').addEventListener('click', navNext);
$('todayNavBtn').addEventListener('click', () => {
  const t = today();
  viewYear = t.getFullYear(); viewMonth = t.getMonth();
  render();
});
$start.addEventListener('change', () => { persistDeviceData({ startDate: $start.value }); render(); });

// Swipe
const getSwipeThreshold = () => Math.max(60, window.innerWidth * 0.12);
let touchStartX = 0;
let touchActive = false;
const startSwipe = e => {
  if (!e.touches || e.touches.length !== 1) return;
  touchActive = true;
  touchStartX = e.touches[0].clientX;
};
const endSwipe = e => {
  if (!touchActive) return;
  touchActive = false;
  const dx = e.changedTouches[0].clientX - touchStartX;
  if (Math.abs(dx) > getSwipeThreshold()) {
    dx > 0 ? navPrev() : navNext();
  }
};
const cancelSwipe = () => { touchActive = false; };
$calWrapper.addEventListener('touchstart', startSwipe, {passive:true});
$calWrapper.addEventListener('touchend', endSwipe, {passive:true});
$calWrapper.addEventListener('touchcancel', cancelSwipe, {passive:true});

// Export
$('exportBtn').addEventListener('click', async () => {
  try {
    const text = `${$label.textContent} ÍµêÎåÄÍ∑ºÎ¨¥Ìëú\n\n` +
      Array.from($cal.querySelectorAll('.cell:not(.empty)')).map(c =>
        `${c.dataset.date}: ${c.dataset.shift}${HOLIDAYS[c.dataset.date]?' ('+HOLIDAYS[c.dataset.date]+')':''}`
      ).join('\n');
    if (navigator.share) {
      await navigator.share({title:'ÍµêÎåÄÍ∑ºÎ¨¥Ìëú',text});
    } else if (navigator.clipboard) {
      await navigator.clipboard.writeText(text);
      showToast('ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§ üìã');
    }
  } catch(e) { showToast('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®'); }
});

// Init
function init() {
  const t = today();
  $start.value = deviceData.startDate || fmt(t);
  viewYear = t.getFullYear(); viewMonth = t.getMonth();
  setThemeMode(deviceData.theme === 'light' ? 'light' : 'dark');
  render();
}

// PWA
const isLocalSession = window.location.protocol === 'file:' || ['localhost', '127.0.0.1', '::1', ''].includes(window.location.hostname);
if ('serviceWorker' in navigator) {
  const unregisterLocalWorkers = () => {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(reg => {
        if ((reg.active && reg.active.scriptURL && reg.active.scriptURL.includes('sw.js')) || (reg.scriptURL && reg.scriptURL.includes('sw.js'))) {
          reg.unregister();
        }
      });
    });
  };
  if (isLocalSession) {
    unregisterLocalWorkers();
  } else {
    navigator.serviceWorker.register('sw.js?v=2').catch(()=>{});
  }
}

init();
</script>
</body>
</html>